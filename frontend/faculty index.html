<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Faculty Dashboard - Daily Coding</title>
  <link rel="stylesheet" href="faculty index.css" />
</head>
<body>
  <div class="container">
    <aside class="sidebar" role="navigation" aria-label="Faculty Navigation">
      <div class="sidebar-header">
        <img src="https://upload.wikimedia.org/wikipedia/en/thumb/d/dd/Official_Logo_of_CHRIST%28Deemed_to_be_University%29%2C_bangalore.jpg/250px-Official_Logo_of_CHRIST%28Deemed_to_be_University%29%2C_bangalore.jpg" alt="CHRIST University Logo" class="logo">
        <div class="brand">
          <h2>Daily Coding</h2>
          <p class="subtitle">College Edition</p>
        </div>
      </div>

      <div class="user-info">
        <div class="user-details">
          <p class="user-greeting">Logged in as:</p>
          <p class="user-name" id="facultyName">Loading...</p>
          <p class="user-role">Faculty</p>
        </div>
      </div>

      <nav class="nav-menu">
        <ul class="nav-links" role="menubar">
          <li role="none">
            <a href="faculty index.html" class="nav-link active" role="menuitem" aria-current="page">
              <span class="nav-icon">üìä</span>
              <span class="nav-text">Student Overview</span>
            </a>
          </li>
          <li role="none">
            <a href="login.html" class="nav-link logout" role="menuitem">
              <span class="nav-icon">üö™</span>
              <span class="nav-text">Logout</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>

    <main class="main-content" role="main">
      <header class="page-header">
        <h1>Student Overview</h1>
        <p class="page-subtitle">Monitor student progress and engagement across all coding challenges</p>
      </header>

      <section class="overview-section">
        <div class="search-container">
          <div class="search-wrapper">
            <input type="search" class="search-input" placeholder="Search students by name or email..." aria-label="Search students">
            <span class="search-icon">üîç</span>
          </div>
          <div class="overview-stats">
            <div class="stat-item">
              <span class="stat-value" id="totalStudents">0</span>
              <span class="stat-label">Total Students</span>
            </div>
            <div class="stat-item">
              <span class="stat-value" id="totalQuestions">0</span>
              <span class="stat-label">Total Questions</span>
            </div>
            <div class="stat-item">
              <span class="stat-value" id="totalSubmissions">0</span>
              <span class="stat-label">Total Submissions</span>
            </div>
          </div>
        </div>

        <div class="students-card card">
          <div class="card-header">
            <h2>Student Performance</h2>
            <div class="filter-options">
              <select class="filter-select" aria-label="Filter by performance">
                <option value="all">All Students</option>
                <option value="high">High Performers</option>
                <option value="medium">Average Performers</option>
                <option value="low">Needs Attention</option>
              </select>
            </div>
          </div>

          <div class="table-container">
            <table class="students-table" role="table" aria-label="Student Performance Data">
              <thead>
                <tr role="row">
                  <th scope="col" class="col-student">Student</th>
                  <th scope="col" class="col-email">Email</th>
                  <th scope="col" class="col-completion">Completion Rate</th>
                  <th scope="col" class="col-activity">Recent Activity</th>
                  <th scope="col" class="col-actions">Actions</th>
                </tr>
              </thead>
              <tbody id="studentsTableBody">
                <!-- Student data will be populated by JavaScript -->
                <tr role="row">
                  <td colspan="5" class="loading-message">Loading student data...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Check authentication on page load
    document.addEventListener('DOMContentLoaded', async function() {
      const token = localStorage.getItem('token');
      const role = localStorage.getItem('role');

      if (!token || role !== 'faculty') {
        alert('Unauthorized access! Please log in as faculty.');
        window.location.href = 'login.html';
        return;
      }

      // Load faculty data
      await loadFacultyDashboard();
      await loadStudents();
    });

    // Load faculty dashboard data
    async function loadFacultyDashboard() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/faculty/dashboard', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();

        if (response.ok && data.success) {
          document.getElementById('totalStudents').textContent = data.data.totalStudents;
          document.getElementById('totalQuestions').textContent = data.data.totalQuestions;
          document.getElementById('totalSubmissions').textContent = data.data.totalSubmissions;
        } else {
          console.error('Failed to load dashboard:', data.message);
        }
      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    // Load students list
    async function loadStudents() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/faculty/students', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();

        if (response.ok && data.success) {
          populateStudentsTable(data.data);
        } else {
          document.getElementById('studentsTableBody').innerHTML =
            '<tr><td colspan="5" class="error-message">Failed to load students: ' + (data.message || 'Unknown error') + '</td></tr>';
        }
      } catch (error) {
        console.error('Error loading students:', error);
        document.getElementById('studentsTableBody').innerHTML =
          '<tr><td colspan="5" class="error-message">Error loading students. Please try again.</td></tr>';
      }
    }

    // Populate students table
    function populateStudentsTable(students) {
      const tbody = document.getElementById('studentsTableBody');

      if (!students || students.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="no-data">No students found</td></tr>';
        return;
      }

      const rows = students.map((student, index) => {
        const studentId = `CS2023${String(index + 1).padStart(3, '0')}`;
        const completionRate = Math.floor(Math.random() * 40) + 60; // Mock completion rate 60-100%
        const performanceClass = completionRate >= 85 ? 'high-performer' :
                                completionRate >= 70 ? 'medium-performer' : 'low-performer';
        const statusClass = completionRate >= 80 ? 'active' :
                           completionRate >= 60 ? 'warning' : 'inactive';

        return `
          <tr role="row" class="student-row ${performanceClass}">
            <td class="student-info">
              <div class="student-details">
                <div class="status-indicator ${statusClass}"></div>
                <div class="student-name">
                  <h4>${student.name}</h4>
                  <span class="student-id">ID: ${studentId}</span>
                </div>
              </div>
            </td>
            <td class="student-email">${student.email}</td>
            <td class="completion-rate">
              <div class="progress-container">
                <div class="progress-bar ${performanceClass.split('-')[0]}">
                  <div class="progress-fill" style="width: ${completionRate}%"></div>
                </div>
                <span class="progress-text">${completionRate}%</span>
              </div>
            </td>
            <td class="recent-activity">
              <div class="activity-info">
                <span class="activity-text">Active student</span>
                <time class="activity-time">Recently</time>
              </div>
            </td>
            <td class="student-actions">
              <a href="fac student overview.html?id=${student._id}" class="action-btn view-btn" title="View Details">
                <span class="btn-icon">üëÅ</span>
                <span class="btn-text">View</span>
              </a>
            </td>
          </tr>
        `;
      }).join('');

      tbody.innerHTML = rows;
    }

    // Handle logout
    document.addEventListener('click', function(e) {
      if (e.target.closest('.logout')) {
        e.preventDefault();
        localStorage.removeItem('token');
        localStorage.removeItem('role');
        window.location.href = 'login.html';
      }
    });

    // Search functionality
    const searchInput = document.querySelector('.search-input');
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('.student-row');

        rows.forEach(row => {
          const name = row.querySelector('.student-name h4').textContent.toLowerCase();
          const email = row.querySelector('.student-email').textContent.toLowerCase();

          if (name.includes(searchTerm) || email.includes(searchTerm)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      });
    }

    // Filter functionality
    const filterSelect = document.querySelector('.filter-select');
    if (filterSelect) {
      filterSelect.addEventListener('change', function() {
        const filter = this.value;
        const rows = document.querySelectorAll('.student-row');

        rows.forEach(row => {
          if (filter === 'all') {
            row.style.display = '';
          } else {
            const hasClass = row.classList.contains(filter + '-performer');
            row.style.display = hasClass ? '' : 'none';
          }
        });
      });
    }
  </script>
</body>
</html>